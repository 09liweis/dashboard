import '../styles/globals.css';
import Head from 'next/head';
import Link from 'next/link';
import { Router, useRouter } from 'next/router';
import type { AppProps } from 'next/app';
import AppContext from '../AppContext';
import { useState, useRef, useEffect } from 'react';
import {
  fetchUser,
  fetchToken,
  checkUserToken,
  getLanguages,
  getLanguageKeys,
  getTranslate,
} from '../helpers';

import Chat from '../components/Chat';

const getPageTitle = (pageProps: any) => {
  const pageMeta = pageProps.pageMeta;
  return pageMeta?.title || 'Dashboard';
};

const NAV_LINKS = [
  { tl: 'home', url: '/', icon: 'fa-solid fa-house-user' },
  { tl: 'knowledges', url: '/knowledges', icon: 'fa-solid fa-book' },
  { tl: 'expense', url: '/expense', icon: 'fa-solid fa-piggy-bank' },
  { tl: 'subscription', url: '/newsletter', icon: 'fa-solid fa-envelope' },
];

interface User {
  _id: string;
  nm: string;
  eml: string;
  lts: string;
}

function MyApp({ Component, pageProps }: AppProps) {
  const emptyUser: User = { _id: '', nm: '', eml: '', lts: '' };
  const [user, setUser] = useState(emptyUser);
  const [lang, setLang] = useState(getLanguages('en'));
  const [showLogin, setShowLogin] = useState(false);

  const [loading, setLoading] = useState(false);
  Router.events.on('routeChangeStart', () => {
    setLoading(true);
  });

  Router.events.on('routeChangeComplete', () => {
    setLoading(false);
  });

  const router = useRouter();

  const usernameInput = useRef<HTMLInputElement>(null);
  const passwordInput = useRef<HTMLInputElement>(null);
  const handleLogin = async (e: React.SyntheticEvent<HTMLFormElement>) => {
    e.preventDefault();
    const body = {
      eml: usernameInput?.current?.value,
      pwd: passwordInput?.current?.value,
    };
    const response = await fetchToken(body);
    if (response.token) {
      localStorage.setItem('auth-token', response.token);
      const userResponse = await fetchUser();
      if (userResponse?.user) {
        setUser(userResponse.user);
      }
    }
  };

  useEffect(() => {
    const userResponse = checkUserToken();
    userResponse.then((res: any) => {
      if (res?.user) {
        setUser(res.user);
      }
    });
  }, []);

  return (
    <>
      <Head>
        <title>{getPageTitle(pageProps)}</title>
        <meta name="keywords" content="" />
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
        <link
          rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"
        />
        <link rel="stylesheet" href="/tailwind.css" />
      </Head>
      <AppContext.Provider
        value={{
          user,
          lang,
          setUser,
        }}
      >
        {/* <Chat /> */}
        <main className="p-3">
          <section className="flex justify-end mb-3">
            {getLanguageKeys().map(({ k, v }) => (
              <a
                className="ml-2 cursor-pointer border p-1 rounded-lg text-white bg-red-400 hover:bg-red-600 transition duration-300"
                onClick={() => setLang(getLanguages(k))}
                key={k}
              >
                {v}
              </a>
            ))}
          </section>
          <header className="sticky top-3 left-3">
            <nav className="flex items-center p-2 bg-card rounded shadow">
              {NAV_LINKS.map((nav) => (
                <Link key={nav.url} href={nav.url}>
                  <span
                    className={`mr-3 cursor-pointer text-red-500 hover:text-red-600 transition duration-300 ${
                      nav.url == router.pathname
                        ? 'border-b-2 border-red-500'
                        : ''
                    }`}
                  >
                    <i className={nav.icon}></i> {getTranslate(lang, nav.tl)}
                  </span>
                </Link>
              ))}
              {user._id ? (
                <>
                  <span className="mr-3 text-red-500 hover:text-red-600 transition duration-300">
                    <i className="fa-solid fa-user"></i> {user.nm}
                  </span>
                  <a
                    className="p-1 text-center rounded-lg cursor-pointer text-white bg-red-400 transition duration-300 hover:rotate-12 hover:bg-red-600"
                    onClick={() => {
                      localStorage.removeItem('auth-token');
                      setUser(emptyUser);
                    }}
                  >
                    Logout
                  </a>
                </>
              ) : (
                <a onClick={() => setShowLogin(true)}>Login</a>
              )}
            </nav>
          </header>
          <section className="bg-card mt-3 p-3 rounded">
            {loading && <div>Loading...</div>}
            <Component {...pageProps} />
          </section>
          {!user._id && showLogin ? (
            <section className="fixed bg-black w-full h-full flex justify-center items-center">
              <form
                className="bg-white p-3 mx-auto w-96"
                onSubmit={handleLogin}
              >
                <input
                  ref={usernameInput}
                  className="border w-full p-3 rounded mb-2"
                  placeholder="User Name"
                />
                <input
                  ref={passwordInput}
                  className="border w-full p-3 rounded mb-2"
                  placeholder="Password"
                />
                <button>Login</button>
              </form>
            </section>
          ) : null}
        </main>
      </AppContext.Provider>
    </>
  );
}

export default MyApp;
